name: Update Leaderboard

on:
  schedule:
    - cron: "0 0 * * *"   # runs daily
  workflow_dispatch:

permissions:
  contents: write

jobs:
  leaderboard:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate leaderboard and update README
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");

            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Fetch contributors
            const contributors = await github.paginate(
              github.rest.repos.listContributors,
              { owner, repo }
              );

            contributors.sort((a, b) => b.contributions - a.contributions);

            if (contributors.length === 0) {
              console.log("No contributors found.");
              return;
            }

            // Build table rows
            const rows = contributors.map((c, i) => {
              return `| ${i + 1} | @${c.login} | ${c.contributions} | ${c.contributions} |`;
            });

            const table =
              "| Rank | Contributor | Points | Commits |\n" +
              "|-----:|------------|-------:|--------:|\n" +
              rows.join("\n");

            // Update README.md
            const start = "<!-- LEADERBOARD_START -->";
            const end = "<!-- LEADERBOARD_END -->";

            let readme = fs.readFileSync("README.md", "utf8");

            if (!readme.includes(start) || !readme.includes(end)) {
              throw new Error("Leaderboard markers not found in README.md");
              }


            const regex = new RegExp(`${start}[\\s\\S]*?${end}`, "m");

            readme = readme.replace(
              regex,
              `${start}\n\n${table}\n\n${end}`
            );

            fs.writeFileSync("README.md", readme);

            // Also write LEADERBOARD.md (optional but nice)
            const leaderboardFile =
              "# ðŸ† Project Toolsuite Leaderboard\n\n" +
              table +
              "\n\n_Last updated: " +
              new Date().toUTCString() +
              "_\n";

            if (
              !fs.existsSync("LEADERBOARD.md") ||
              fs.readFileSync("LEADERBOARD.md", "utf8") !== leaderboardFile
              ) {
              fs.writeFileSync("LEADERBOARD.md", leaderboardFile);
              }


            const htmlListItems = contributors.map(c => {
                return `                <li>\n                    <span class="contributor-name">${c.login}</span>\n                    <a href="${c.html_url}" class="contributor-link" target="_blank">@${c.login}</a>\n                </li>`;
            });

            const htmlBlock = htmlListItems.join("\n");

            try {
                let htmlFile = fs.readFileSync("contributers.html", "utf8");
                
                // Regex to find the <ul class="contributors-list"> and replace its contents
                // This preserves the outer <ul> tags but replaces everything inside them
                const listRegex = /(<ul class="contributors-list">)[\s\S]*?(<\/ul>)/;
                
                if (listRegex.test(htmlFile)) {
                    htmlFile = htmlFile.replace(listRegex, `$1\n${htmlBlock}\n$2`);
                    fs.writeFileSync("contributers.html", htmlFile);
                    console.log("Successfully updated contributers.html");
                } else {
                    console.log("Warning: Could not find <ul class='contributors-list'> in contributers.html");
                }
            } catch (err) {
                console.log("Error updating contributers.html: " + err.message);
            }

      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add README.md LEADERBOARD.md contributers.html
          git commit -m "chore: update contributors leaderboard" || echo "No changes"
          git push
